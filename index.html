<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiboN 会員証</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-size: 0.9rem; }
        .card { border-radius: 12px; border: none; }
        .required::after { content: " *"; color: #dc3545; }
        .form-label { font-weight: 600; color: #495057; }
    </style>
</head>
<body>
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success"></div>
        <p id="status" class="mt-3 fw-bold">システムを起動中...</p>
    </div>

    <div id="app" class="container py-4" style="display:none;"></div>

    <script>
        // --- 設定値 ---
        const LIFF_ID = "2008741629-Jtd0iNts";
        const GAS_URL = "https://script.google.com/macros/s/AKfycby4lCf_VsvOexW-8j_FlgZ7Q-9LmsOEhMqr6TtOBEOE-BlXsEVwq_QOiSSQ430IFvE/exec"; 

        async function init() {
            const status = document.getElementById('status');
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }

                const profile = await liff.getProfile();
                const userId = profile.userId;

                status.innerText = "会員情報を照会しています...";
                const res = await fetch(`${GAS_URL}?uid=${userId}`);
                const data = await res.json();

                document.getElementById('loading').style.display = 'none';
                const app = document.getElementById('app');
                app.style.display = 'block';

                if (data.found) {
                    renderCard(data);
                } else {
                    renderForm(userId);
                }
            } catch (err) {
                status.innerHTML = `<div class="alert alert-danger mx-3">起動エラー: ${err.message}</div>`;
            }
        }

        function renderForm(userId) {
            document.getElementById('app').innerHTML = `
                <div class="card shadow p-4 mb-5">
                    <h5 class="text-center mb-4 fw-bold">新規会員登録</h5>
                    <form id="regForm">
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="form-label required">姓</label><input type="text" id="lastName" class="form-control" placeholder="山田" required></div>
                            <div class="col-6"><label class="form-label required">名</label><input type="text" id="firstName" class="form-control" placeholder="太郎" required></div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="form-label required">セイ（カナ）</label><input type="text" id="lastKana" class="form-control" placeholder="ヤマダ" required></div>
                            <div class="col-6"><label class="form-label required">メイ（カナ）</label><input type="text" id="firstKana" class="form-control" placeholder="タロウ" required></div>
                        </div>
                        <div class="mb-3"><label class="form-label required">電話番号</label><input type="tel" id="mobileNumber" class="form-control" placeholder="09012345678" required></div>
                        <div class="mb-3"><label class="form-label">メールアドレス</label><input type="email" id="mailAddress" class="form-control" placeholder="example@mail.com"></div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="form-label required">性別</label>
                                <select id="sex" class="form-select">
                                    <option value="0">不明</option>
                                    <option value="1">男性</option>
                                    <option value="2">女性</option>
                                </select>
                            </div>
                            <div class="col-6"><label class="form-label required">生年月日</label><input type="date" id="birthDate" class="form-control"></div>
                        </div>
                        <div class="mb-3"><label class="form-label required">郵便番号</label><input type="text" id="postCode" class="form-control" placeholder="1234567"></div>
                        <div class="mb-3"><label class="form-label required">住所</label><input type="text" id="address" class="form-control" placeholder="東京都渋谷区..."></div>
                        <div class="mb-3"><label class="form-label required">SNSへの写真掲載について</label>
                                <select id="note" class="form-select">
                                    <option value="SNS掲載可">当店SNSへの写真掲載許諾</option>
                                    <option value="SNS掲載不可">当店SNSへの写真掲載不可</option>
                                </select></div>
                        <div class="mb-3"><label class="form-label">備考</label><textarea id="note2" class="form-control" placeholder="アレルギーや紹介者名（あれば）" rows="2"></textarea></div>
                        <button type="submit" id="subBtn" class="btn btn-success w-100 py-3 mt-3 fw-bold">登録を完了する</button>
                    </form>
                </div>`;

            document.getElementById('regForm').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('subBtn');
                btn.disabled = true;
                btn.innerText = "スマレジに登録中...";

                const payload = {
                    lineUserId: userId,
                    lastName: document.getElementById('lastName').value,
                    firstName: document.getElementById('firstName').value,
                    lastKana: document.getElementById('lastKana').value,
                    firstKana: document.getElementById('firstKana').value,
                    mobileNumber: document.getElementById('mobileNumber').value,
                    mailAddress: document.getElementById('mailAddress').value,
                    sex: document.getElementById('sex').value,
                    birthDate: document.getElementById('birthDate').value,
                    postCode: document.getElementById('postCode').value,
                    address: document.getElementById('address').value,
                    note: document.getElementById('note').value,
                    note2: document.getElementById('note2').value
                };

                try {
                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert("会員登録が完了しました！");
                        location.reload();
                    } else {
                        throw new Error(result.error || "登録に失敗しました");
                    }
                } catch (err) {
                    alert("エラー: " + err.message);
                    btn.disabled = false;
                    btn.innerText = "登録を完了する";
                }
            };
        }

        function renderCard(data) {
            // もし data.code が無ければエラーを表示
            if (!data.code) {
                alert("会員コードの取得に失敗しました。");
                return;
            }

            document.getElementById('app').innerHTML = `
                <div class="card bg-success text-white shadow-lg border-0 mb-3">
                    <div class="card-body p-4 text-center">
                        <p class="small text-uppercase mb-2" style="letter-spacing: 2px;">Membership Card</p>
                        <h4 class="mb-4">${data.name} 様</h4>
                        
                        <div class="bg-white text-dark rounded-pill py-2 px-4 d-inline-block mb-4 shadow-sm">
                            <span class="small fw-bold">保有ポイント:</span>
                            <span class="h4 mb-0 fw-bold text-success"> ${data.point} </span>
                            <span class="small">pt</span>
                        </div>

                        <div class="bg-white p-3 rounded mb-3">
                            <img src="https://barcodeapi.org/api/128/${data.code}" 
                                style="max-width: 100%; height: auto;" 
                                onerror="this.src='https://placehold.jp/24/cccccc/ffffff/250x80.png?text=BarcodeError'"
                                alt="Barcode">
                        </div>
                        <p class="mb-0 small opacity-75">No. ${data.code}</p>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button onclick="location.reload()" class="btn btn-outline-secondary btn-sm rounded-pill mt-2">
                        情報を更新する
                    </button>
                </div>`;
        }
        init();
    </script>
</body>
</html>
